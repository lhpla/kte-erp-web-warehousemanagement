<!-- warehousDetailLog  仓储异常查看异常详情弹框  -->
<template>
  <div id="warehousDetailLog">
    <el-dialog title="查看异常" v-model="dialogVisible" width="80%" :close-on-click-modal="false" @close="closed" :close-on-press-escape="false">
      <div class="detailInfo">
        <div class="po">PO号:{{ dataObj.orderCode }}</div>
        <div class="logistics">物流号:{{ dataObj.logisticsNum }}</div>
        <div class="sku">SKU:{{ dataObj.sku }}</div>
      </div>
      <el-table
        v-loading="loading"
        :data="tableData"
        border
        :span-method="objectSpanMethod"
        :header-cell-style="{ background: '#fafafa', color: '#2d2f30', fontWeight: 'bold', fontSize: '12px' }"
        style="width: 100%"
      >
        <!-- :height="screenHeight" -->
        <el-table-column label="中转仓库" prop="warehouseName" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span>{{ scope.row.warehouseName }}</span>
          </template>
        </el-table-column>
        <el-table-column label="仓区" prop="warehouse" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span>{{ scope.row.warehouse }}</span>
          </template>
        </el-table-column>
        <el-table-column label="采购建议数量" prop="num" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span>{{ scope.row.num }}</span>
          </template>
        </el-table-column>
        <el-table-column label="收货数量" prop="receiptNum" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span>{{ scope.row.receiptNum }}</span>
          </template>
        </el-table-column>
        <el-table-column label="异常数量" prop="num" align="center" show-overflow-tooltip>
          <span>{{ dataObj.num }}</span>
        </el-table-column>
        <el-table-column label="异常类型" align="center" show-overflow-tooltip>
          <div :key="tag" v-for="tag in abnormalMessagesList" style="margin-bottom: 5px">
            <el-tag class="tags-class">
              <span>{{ tableTypeComputed(tag) }}</span>
            </el-tag>
          </div>
        </el-table-column>
        <el-table-column label="异常描述" align="center" show-overflow-tooltip>
          <div :key="tag" v-for="(tag, i) in abnormalMessages" class="tags-class">
            <span v-if="tag && i < 1">{{ tag.messagesListDto.abnormalContext }}</span>
          </div>
          <el-button type="text" size="mini" @click="allContext('context')">更多</el-button>
        </el-table-column>
        <el-table-column label="异常图片" align="center" show-overflow-tooltip>
          <div v-if="abnormalMessages && abnormalMessages.length > 0">
            <div v-for="(item, index) in abnormalMessages[0].messagesListDto.abnormalImageUrl" :key="index">
              <span v-if="index < 1 && item">
                <el-popover placement="right" trigger="hover" width="250">
                  <template #reference>
                    <el-image style="width: 100px; height: 90px" fit="contain" :src="item"></el-image>
                  </template>
                  <el-image :src="item" style="width: 400px; height: 300px" fit="contain"></el-image>
                </el-popover>
              </span>
            </div>
            <el-button v-if="abnormalMessages[0].messagesListDto.abnormalImageUrl.length > 0" type="text" size="mini" @click="allContext('img')">更多</el-button>
          </div>
        </el-table-column>
      </el-table>
      <div class="detailBottom">
        <div>异常类型</div>
        <div>反馈时间</div>
        <div>操作</div>
      </div>
      <div v-for="(item, index) in abnormalMessages" :key="index">
        <div class="detailBottomContent">
          <div class="minTitle">{{ tableTypeComputed(item.abnormalType) }}</div>
          <div class="minTitle" v-if="item.messagesListDto.messageDto.length">{{ item.messagesListDto.messageDto[0].createTime }}</div>
          <div class="minTitle">
            <el-button type="text" @click="exception(item)">回复异常</el-button>
            <!-- :disabled="treatmentMethod" -->
            <el-button type="text" @click="end(item)">异常结束</el-button>
          </div>
        </div>
        <div class="contentBox">
          <div class="detailText">
            <div style="display: flex">
              <div style="width: 100px; line-height: 30px">处理方式 :</div>
              <span v-if="JSON.stringify(item.messagesListDto.processingMethod) == '{}' && index == 0" style="display: flex; margin-left: 10px">
                <el-select filterable clearable v-model="treatmentMethod" size="mini" placeholder="请选择">
                  <el-option v-for="item in abnormal_processing_method" :key="item.dizKey" :label="item.value" :value="item.dizKey"></el-option>
                </el-select>
                <el-button style="margin-left: 10px" type="primary" size="mini" :loading="btnFlag" :disabled="btnFlag" @click="SettingMode">保存</el-button>
              </span>
              <span v-else style="line-height: 30px">
                {{ Treatment(item.messagesListDto.processingMethod) }}
              </span>
            </div>
          </div>
          <div class="messageDto" v-for="(i, k) in item.messagesListDto.messageDto" :key="k">
            <div>
              <span class="minName">{{ i.createUserName }}</span>
              &nbsp;&nbsp;&nbsp;&nbsp;
              {{ i.createTime }}
            </div>
            <div class="item_message_box">
              <div class="i_detailText">{{ i.context }}</div>
              <div class="detailImg">
                <div v-for="(e, q) in i.imageUrl" :key="q">
                  <el-popover placement="right" trigger="hover" width="250">
                    <template #reference>
                      <el-image style="width: 80px; height: 80px" fit="contain" :src="e"></el-image>
                    </template>
                    <el-image :src="e" style="width: 400px; height: 300px" fit="contain"></el-image>
                  </el-popover>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </el-dialog>

    <!-- 回复异常 -->
    <ReplyExceptionLog ref="ReplyExceptionLog"></ReplyExceptionLog>
    <!-- 查看更多 -->
    <WarehousMore ref="WarehousMore"></WarehousMore>
    <!-- 结束异常 -->
    <EndExceptionLog ref="EndExceptionLog"></EndExceptionLog>
  </div>
</template>

<script>
import { reactive, toRefs, ref, onBeforeMount, onMounted, getCurrentInstance, computed, nextTick, provide } from "vue";
import ReplyExceptionLog from "./replyExceptionLog.vue";
import WarehousMore from "./warehousMore.vue";
import EndExceptionLog from "./EndExceptionLog.vue";
import { localGet } from "@/utils/util";
export default {
  name: "warehousDetailLog",
  components: { ReplyExceptionLog, WarehousMore, EndExceptionLog },

  setup(prop, ctx) {
    const data = reactive({
      //按钮loading
      btnFlag: false,
      // 弹框flag
      dialogVisible: false,
      // 表格数据
      tableData: [],
      // 表格loading
      loading: false,
      // 表格后部分数据
      dataObj: {},
      // 异常类型
      warehouse_abnormal_type: [],
      // 异常类型数据
      abnormalMessages: [],
      // 处理方式字典
      abnormal_processing_method: [],
      //保存请求详情的po单和sku
      detailInfo: {},
      //treatmentMethod 设置方式值
      treatmentMethod: "",
      //
      userIds: {},
      abnormalMessagesList: [],
    });
    const { ctx: vueDev, proxy: vue } = getCurrentInstance();
    const api = vue.$http;
    onBeforeMount(() => {});
    onMounted(() => {});

    // 打开弹框
    const openLog = row => {
      let msg = {
        orderCode: row.orderCode,
        abnormalType: row.abnormalType,
        sku: row.sku,
      };
      data.detailInfo = msg;
      data.warehouse_abnormal_type = localGet("purchaseDict") && localGet("purchaseDict").warehouse_abnormal_type ? localGet("purchaseDict").warehouse_abnormal_type : [];
      data.dialogVisible = true;
      checkAbnormalMessages(row.orderCode, row.sku, row.abnormalType);
    };

    //获取信息
    const checkAbnormalMessages = (orderCode, sku, abnormalType) => {
      api.warehouse.checkAbnormalMessages({ orderCode: orderCode, sku: sku, abnormalType: abnormalType }).then(res => {
        if (res.code == 200) {
          data.abnormal_processing_method = res.data.abnormalProcessingMethod ? res.data.abnormalProcessingMethod : [];
          res.data.warehouses.map(item => {
            item.warehouseName = res.data.warehouseName;
          });
          data.abnormalMessages = res.data.abnormalMessages;
          for (let it of data.abnormalMessages) {
            data.abnormalMessagesList.push(it.abnormalType);
          }
          data.abnormalMessagesList = [...new Set(data.abnormalMessagesList)];
          data.tableData = res.data.warehouses;
          let obj = {
            num: res.data.number,
            orderCode: res.data.orderCode,
            logisticsNum: res.data.logisticsNum,
            sku: res.data.sku,
          };
          data.dataObj = obj;
          data.treatmentMethod =
            JSON.stringify(res.data.abnormalMessages[0].messagesListDto.processingMethod) !== "{}" ? res.data.abnormalMessages[0].messagesListDto.processingMethod : "";
          let userIds = {
            financeUserId: res.data.financeUserId, //
            buyerId: res.data.buyerId, //
            qualityInspectorId: res.data.qualityInspectorId, //
            signer: res.data.signer,
          };
          data.userIds = userIds;
        }
      });
    };

    provide("checkAbnormalMessages", checkAbnormalMessages);

    //确认设置处理方式 SettingMode
    const SettingMode = () => {
      if (data.treatmentMethod) {
        data.btnFlag = true;
        let vo = {
          logisticsNum: data.dataObj.logisticsNum,
          orderCode: data.dataObj.orderCode,
          processingMethod: data.treatmentMethod,
          sku: data.dataObj.sku,
          abnormalType: data.detailInfo.abnormalType,
        };

        api.warehouse
          .processingMethod(vo)
          .then(res => {
            if (res.code == 200) {
              vue.$message.success(res.msg);
              openLog(data.detailInfo);

              data.btnFlag = false;
            } else {
              vue.$message.warning(res.msg);
              data.btnFlag = false;
            }
          })
          .catch(e => {
            data.btnFlag = false;
          });
      } else {
        vue.$message.warning("请先选择处理方式！");
      }
    };

    // 点击异常描述更多按钮 / 异常图片
    const allContext = type => {
      vue.$refs.WarehousMore.getMsg(type, data.abnormalMessages);
    };

    // 取消
    const closed = () => {
      data.dialogVisible = false;
    };

    // 计算表格字典
    const tableTypeComputed = type => {
      let val = "";
      data.warehouse_abnormal_type.map(item => {
        if (item.dizKey == type) {
          val = item.value;
        }
      });
      return val;
    };

    // 计算处理方式字典
    const Treatment = dizKey => {
      let text = "";
      data.abnormal_processing_method.map(item => {
        if (item.dizKey == dizKey) {
          text = item.value;
        }
      });
      return text;
    };

    // 合并table
    const objectSpanMethod = ({ row, column, rowIndex, columnIndex }) => {
      if (columnIndex === 4) {
        return {
          rowspan: data.tableData.length,
          colspan: rowIndex - 1,
        };
      }
      if (columnIndex === 5) {
        return {
          rowspan: data.tableData.length,
          colspan: rowIndex - 1,
        };
      }
      if (columnIndex === 6) {
        return {
          rowspan: data.tableData.length,
          colspan: rowIndex - 1,
        };
      }
      if (columnIndex === 7) {
        return {
          rowspan: data.tableData.length,
          colspan: rowIndex - 1,
        };
      }
    };

    // 回复异常
    const exception = e => {
      let msg = {
        abnormalType: e.abnormalType,
        sku: data.dataObj.sku,
        orderCode: data.dataObj.orderCode,
        processingMethod: e.messagesListDto.processingMethod ? e.messagesListDto.processingMethod : "",
      };
      vue.$refs.ReplyExceptionLog.openLog(msg);
    };

    // 结束异常
    const end = e => {
      if (data.treatmentMethod) {
        let arr = [];
        data.tableData.map((item, index) => {
          let obj = {
            warehouseName: item.warehouseName,
            warehouse: item.warehouse,
            num: item.num,
            receiptNum: item.receiptNum,
            abnormalNum: data.dataObj.num,
            newNum: 0,
          };
          arr.push(obj);
        });
        let info = {
          abnormalNumber: data.dataObj.num,
          abnormalType: e.abnormalType,
          buyerId: data.userIds.buyerId,
          financeUserId: data.userIds.financeUserId,
          qualityInspectorId: data.userIds.qualityInspectorId,
          signer: data.userIds.signer,
          orderCode: data.dataObj.orderCode,
          processingMethod: e.messagesListDto.processingMethod,
          serialNumber: data.dataObj.logisticsNum,
          sku: data.dataObj.sku,
        };
        nextTick(() => {
          vue.$refs.EndExceptionLog.getMsg(arr, info);
        });
      } else {
        vue.$message.warning("没有对应处理方式,请选择处理方式!");
      }
    };

    const refData = toRefs(data);
    return {
      ...refData,
      closed,
      openLog,
      tableTypeComputed,
      allContext,
      objectSpanMethod,
      Treatment,
      exception,
      end,
      SettingMode,
      checkAbnormalMessages,
    };
  },
};
</script>
<style scoped lang="scss">
#warehousDetailLog {
  .detailInfo {
    display: flex;
    margin-bottom: 20px;
    .po {
      width: 30%;
    }
    .logistics {
      width: 30%;
      margin-left: 3%;
    }
    .sku {
      width: 30%;
      margin-left: 3%;
    }
  }
  .detailBottom {
    width: 100%;
    background: #f9f9f9;
    height: 40px;
    border-top: 1px solid #e9e9e9;
    border-bottom: 1px solid #e9e9e9;
    display: flex;
    justify-content: space-between;
    div {
      color: #666666;
      height: 40px;
      line-height: 40px;
      font-size: 14px;
      width: 25%;
      margin-left: 5%;
    }
  }
  .detailBottomContent {
    width: 100%;
    display: flex;
    justify-content: space-between;
    height: 40px;
    border-bottom: 1px solid #e9e9e9;
    .minTitle {
      line-height: 40px;
      color: #666666;
      width: 33%;
      margin-left: 5%;
    }
  }
  .contentBox {
    width: 100%;
    margin-bottom: 20px;
    .detailText {
      width: 25%;
      margin-left: 5%;
      display: flex;
      margin-top: 15px;
      font-size: 13px;
      font-weight: bold;
    }
    .messageDto {
      width: 65%;
      margin-left: 5%;
      margin-top: 10px;
      border-bottom: 1px dashed #666666;
      .minName {
        font-size: 13px;
        font-weight: bold;
      }
      .minTime {
        font-size: 13px;
        font-weight: bold;
      }
      .item_message_box {
        width: 100%;
        display: flex;
        margin-top: 20px;
        .i_detailText {
          width: 50%;
        }
        .detailImg {
          margin-left: 5%;
          width: 50%;
          display: flex;
          flex-wrap: wrap;
          div {
            margin-left: 5px;
          }
        }
      }
    }
  }
}
</style>
