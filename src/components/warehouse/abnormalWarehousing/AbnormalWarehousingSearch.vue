<!-- 仓储异常搜索 -->
<template>
  <div id="SearchPanel">
    <el-form :inline="true" ref="formInlineRef" label-width="90px" :model="searchForm" class="demo-form-inline el-from">
      <div class="form-content" :class="{ collapseClass: searchShow }">
        <el-form-item label="单号:" class="SearchPanel-form-item">
          <div class="flex">
            <el-select v-model="searchForm.orderCodeType" clearable filterable placeholder="请选择" class="size-width">
              <el-option v-for="item in orderCodeTypeList" :key="item.key" :label="item.value" :value="item.key">
              </el-option>
            </el-select>
            <el-input clearable v-model.trim="searchForm.orderCode" @keyup.enter="search"></el-input>
          </div>
        </el-form-item>
        <el-form-item label="供应商:" class="SearchPanel-form-item">
          <SupplierPublic @handChange="searcHandChange"></SupplierPublic>
        </el-form-item>
        <el-form-item label="采购员:" class="SearchPanel-form-item">
          <el-select filterable clearable v-model="searchForm.buyerId" placeholder="请选择" @change="search">
            <el-option v-for="item in purchaseUserList" :key="item.id" :label="item.name" :value="item.id"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="质检员:" class="SearchPanel-form-item">
          <el-select filterable clearable v-model="searchForm.qualityId" placeholder="请选择" @change="search">
            <el-option v-for="item in qualityTestingList" :key="item.id" :label="item.name" :value="item.id">
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="中转仓库:" class="SearchPanel-form-item">
          <el-select v-model="searchForm.warehouseId" filterable clearable placeholder="请选择" @change="search">
            <el-option v-for="item in wareHouseList" :key="item.id" :label="item.name" :value="item.id"></el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="签收员:" class="SearchPanel-form-item">
          <el-select filterable clearable v-model="searchForm.signer" placeholder="请选择" @change="search">
            <el-option v-for="item in signForList" :key="item.id" :label="item.name" :value="item.id"></el-option>
          </el-select>
        </el-form-item>
      </div>
      <div class="search-wei" :class="{ searchShow: !searchShow }">
        <el-form-item label="异常类型:" class="SearchPanel-form-item">
          <el-checkbox-group v-model="searchForm.abnormalTypeList" @change="
            changeClick(
              searchForm.abnormalTypeList,
              'abnormalTypeList',
              exceptionTypeList.length
            )
          ">
            <el-checkbox-button label="0">全部</el-checkbox-button>
            <el-checkbox-button v-for="item in exceptionTypeList" :label="item.dizKey" :key="item.dizKey">
              {{ item.value }}
            </el-checkbox-button>
          </el-checkbox-group>
        </el-form-item>
        <el-form-item label="异常状态:" class="SearchPanel-form-item">
          <el-checkbox-group v-model="searchForm.abnormalStatusList" @change="
            changeClick(
              searchForm.abnormalStatusList,
              'abnormalStatusList',
              exceptionStateList.length
            )
          ">
            <el-checkbox-button label="0">全部({{ allAbnormalNumber }})</el-checkbox-button>
            <el-checkbox-button v-for="item in exceptionStateList" :label="item.dizKey" :key="item.dizKey">
              {{ item.value }}({{ item.num }})
            </el-checkbox-button>
          </el-checkbox-group>
        </el-form-item>
      </div>

      <div class="footer-button">
        <el-form-item>
          <el-button type="primary" text size="small" class="open footer-button-expand"
            @click="searchShow = !searchShow" v-if="showSearchBtn">
            {{ searchShow ? "合并" : "展开" }}
            <i class="el-icon--right" :class="searchShow ? 'el-icon-arrow-up' : 'el-icon-arrow-down'"></i>
          </el-button>
          <el-button type="primary" size="small" @click="search">搜 索</el-button>
        </el-form-item>
      </div>
    </el-form>
  </div>
</template>

<script>
import {
  reactive,
  toRefs,
  ref,
  onBeforeMount,
  onMounted,
  getCurrentInstance,
  inject,
} from "vue";
import { useShowSearchBtn } from "@/compositionApi/useShowSearchBtn";
import { localGet } from "@/utils/util";
export default {
  name: "AbnormalWarehousingSearch",
  props: ["searchMsg"],
  setup(prop, ctx) {
    const { showSearchBtn } = useShowSearchBtn();
    const data = reactive({
      searchForm: {
        abnormalTypeList: ["0"],
        abnormalStatusList: ["0"],
        orderCodeType: "orderCode",
      },
      orderCodeTypeList: [
        { key: "orderCode", value: "采购单号" },
        { key: "logisticsNum", value: "物流号" },
      ],
      purchaseUserList: [], // 采购员
      wareHouseList: [], // 中转仓
      searchShow: false,
      warehouse_abnormal_type: [], //异常类型
      qualityTestingList: [], //质检员
      signForList: [], //签收员
      // 异常类型
      exceptionTypeList: [],
      //异常状态
      exceptionStateList: [
        {
          dizKey: "not_processed",
          value: "未处理",
          num: 0,
        },
        {
          dizKey:
            "purchase_confirmation,purchase_leader_audit,purchase_leader_refusal,purchase_reconfirmation",
          value: "待采购处理",
          num: 0,
        },
        {
          dizKey: "develop_to_be_confirmed",
          value: "待开发处理",
          num: 0,
        },
        {
          dizKey:
            "finance_confirmation,finance_refusal,to_finance_returned_paid,to_finance_deduct,",
          value: "待财务处理",
          num: 0,
        },
        {
          dizKey:
            "warehouse_confirmation,warehouse_leader_audit,warehouse_leader_refusal,to_warehouse_delivery,",
          value: "待仓库处理",
          num: 0,
        },
        {
          dizKey: "the_end",
          value: "已结束",
          num: 0,
        },
      ],
      //异常流程总数量
      allAbnormalNumber: 0,
    });
    const { ctx: vueDev, proxy: vue } = getCurrentInstance();
    const api = vue.$http;
    onBeforeMount(() => { });
    onMounted(() => {
      getDictList();
      data.exceptionTypeList = localGet("purchaseDict").abnormal_new_type
        ? localGet("purchaseDict").abnormal_new_type
        : [];
      // data.exceptionStateList = localGet("purchaseDict").abnormal_process_status ? localGet("purchaseDict").abnormal_process_status : [];
      api.warehouse.getUsersOfWarehouse().then((res) => {
        if (res.code == 200) {
          data.signForList = res.data;
          data.qualityTestingList = res.data;
        }
      });

      api.warehouse.getAbnormalNumberOfProcesses().then((res) => {
        if (res.code == 200) {
          calculationException(res.data);
        }
      });
    });

    //匹配采购异常流程状态的数量
    const calculationException = (list) => {
      if (list.length) {
        data.exceptionStateList.map((item) => {
          list.map((ite) => {
            if (item.dizKey.indexOf(ite.abnormalStatus) !== -1) {
              item.num += ite.abnormalNumber;
            }
          });
          data.allAbnormalNumber += item.num;
        });
      }
    };

    const getTableList = inject("getTableList");
    const refData = toRefs(data);
    const getDictList = () => {
      // 中转仓
      api.system.getWareHouseList({ type: 1 }).then((res) => {
        if (res.code == 200) {
          data.wareHouseList = res.data;
        }
      });
      // 采购员
      api.userOperation.getHeadOfPurchasing().then((res) => {
        if (res.code == 200) {
          data.purchaseUserList = res.data;
        }
      });
    };
    // 搜索供应商
    const searcHandChange = (e) => {
      data.searchForm.supplierId = e;
      search()
    };

    //刷新列表/搜索列表
    const search = () => {
      let exceptionStateArr = [];
      if (data.searchForm.abnormalStatusList[0] != "0") {
        data.searchForm.abnormalStatusList.map((item) => {
          exceptionStateArr = exceptionStateArr.concat(item.split(","));
        });
        exceptionStateArr = exceptionStateArr.filter((i) => {
          return i != "";
        });
      }
      console.log(data.searchForm.wareStatusList);
      let msg = {
        supplierId: data.searchForm.supplierId
          ? data.searchForm.supplierId
          : "",
        buyerId: data.searchForm.buyerId ? data.searchForm.buyerId : "",
        transferWarehouseId: data.searchForm.warehouseId
          ? data.searchForm.warehouseId
          : "",
        signerId: data.searchForm.signer ? data.searchForm.signer : "",
        qualityInspectorId: data.searchForm.qualityId
          ? data.searchForm.qualityId
          : "",
        size: vue.searchMsg.size,
        current: vue.searchMsg.current,
        abnormalTypeList:
          data.searchForm.abnormalTypeList[0] == "0"
            ? null
            : data.searchForm.abnormalTypeList,
        abnormalStatusList:
          data.searchForm.abnormalStatusList[0] == "0"
            ? null
            : exceptionStateArr,
        orderCode: data.searchForm.orderCode ? data.searchForm.orderCode : "",
        qualityInspectorId: data.searchForm.qualityId
          ? data.searchForm.qualityId
          : "",
      };
      if (data.searchForm.orderCodeType && data.searchForm.orderCode) {
        msg[data.searchForm.orderCodeType] = data.searchForm.orderCode;
      }
      if (data.searchForm.orderCodeType != '') {
        if (data.searchForm.orderCodeType == 'orderCode') {
          delete msg.logisticsNum
        } else {
          delete msg.orderCode
        }
      } else {
        delete msg.logisticsNum
        delete msg.orderCode
      }
      msg.scroll = 0;
      getTableList(msg);
    };

    // 多选改变
    const changeClick = (arr, name, length) => {
      if (arr.length > 0) {
        if (arr.length == length && arr[0] !== "0") {
          data.searchForm[name] = ["0"];
        } else if (arr[0] == "0") {
          let findResult = arr.indexOf("0");
          if (findResult !== -1) {
            data.searchForm[name].splice(findResult, 1);
          }
        } else {
          let findResult = arr.indexOf("0");
          if (findResult !== -1) {
            data.searchForm[name] = ["0"];
          }
        }
      } else {
        data.searchForm[name] = ["0"];
      }
      search()
    };

    return {
      ...refData,
      searcHandChange,
      search,
      getTableList,
      showSearchBtn,
      changeClick,
      calculationException
    };
  },
};
</script>
<style scoped lang="scss">
#SearchPanel {
  margin: 0;

  .size-width {
    width: 35%;
    margin-right: 10px;
  }

  .el-form-item {
    margin-bottom: 5px !important;
  }

  .form-content {
    height: 35px;
    overflow: hidden;
    transition: all 0.5s !important;
  }

  .collapseClass {
    height: auto;
    overflow: auto;
    transition: all 1s;
  }

  .footer-button {
    display: flex;
    justify-content: flex-end;
    margin-top: 5px;
  }
}

.searchShow {
  margin-top: 20px;
}

@media screen and (min-width: 2000px) {
  .footer-button-expand {
    display: none !important;
  }

}
</style>
