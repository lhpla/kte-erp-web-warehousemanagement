<!-- EndExceptionLog  结束异常弹框 -->
<template>
  <div id="EndExceptionLog">
    <el-dialog title="确认操作" v-model="dialogVisible" :close-on-click-modal="false" width="60%" @close="closed" :close-on-press-escape="false">
      <el-table
        :data="tableData"
        border
        :span-method="objectSpanMethod"
        :header-cell-style="{ background: '#fafafa', color: '#2d2f30', fontWeight: 'bold', fontSize: '12px' }"
        style="width: 100%"
      >
        <el-table-column label="中转仓库" prop="warehouseName" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span>{{ scope.row.warehouseName }}</span>
          </template>
        </el-table-column>
        <el-table-column label="仓区" prop="warehouse" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span>{{ scope.row.warehouse }}</span>
          </template>
        </el-table-column>
        <el-table-column label="采购建议数量" prop="num" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span>{{ scope.row.num }}</span>
          </template>
        </el-table-column>
        <el-table-column label="收货数量" prop="receiptNum" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span>{{ scope.row.receiptNum }}</span>
          </template>
        </el-table-column>
        <el-table-column label="另建采购数量" prop="newNum" align="center" show-overflow-tooltip>
          <template #default="scope">
            <el-input type="number" size="mini" clearable v-model.trim="scope.row.newNum"></el-input>
          </template>
        </el-table-column>
        <el-table-column label="异常数量" prop="abnormalNum" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span>{{ scope.row.abnormalNum }}</span>
          </template>
        </el-table-column>
      </el-table>
      <div class="additionCreat" v-if="infomation.processingMethod == 'addition_creat'">
        <div class="lable-additionCreat">另建采购单的PO单号:</div>
        <el-input clearable v-model.trim="poForm.additionCreatOrderCode" size="mini" placeholder="请输入另建采购单的PO单号"></el-input>
      </div>
      <template #footer>
        <span class="dialog-footer">
          <el-button size="mini" @click="closed">取 消</el-button>
          <el-button size="mini" type="primary" :loading="btnFlag" :disabled="btnFlag" @click="onSubmit">确 定</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script>
import { reactive, toRefs, ref, onBeforeMount, onMounted, getCurrentInstance, nextTick } from "vue";
export default {
  name: "EndExceptionLog",
  props: {},
  setup(prop, ctx) {
    const data = reactive({
      dialogVisible: false,
      tableData: [],
      btnFlag: false,
      infomation: {},
      poForm: {
        additionCreatOrderCode: "",
      },
    });
    const { ctx: vueDev, proxy: vue } = getCurrentInstance();
    const api = vue.$http;
    onBeforeMount(() => {});
    onMounted(() => {});
    const refData = toRefs(data);

    //打开弹框
    const getMsg = (msg, info) => {
      data.infomation = info;
      data.tableData = msg;
      data.dialogVisible = true;
    };

    //关闭弹框
    const closed = () => {
      data.dialogVisible = false;
      data.tableData = [];
      data.infomation = {};
      data.poForm.additionCreatOrderCode = "";
    };

    // 合并table
    const objectSpanMethod = ({ row, column, rowIndex, columnIndex }) => {
      if (columnIndex === 5) {
        return {
          rowspan: data.tableData.length,
          colspan: rowIndex - 1,
        };
      }
    };

    //确认结束
    const onSubmit = () => {
      let vo = {
        abnormalNumber: "",
        abnormalType: "",
        buyerId: "",
        financeUserId: "",
        qualityInspectorId: "",
        signer: "",
        orderCode: "",
        processingMethod: "",
        serialNumber: "",
        sku: "",
        messageWarehouseVos: [],
      };
      //收集另建采购数量
      let number = 0;
      data.tableData.map(e => {
        number += Number(e.newNum);
      });

      if (
        data.tableData.every(e => {
          return number <= e.abnormalNum;
        })
      ) {
        data.tableData.map((item, index) => {
          let vo1 = {
            num: item.newNum,
            warehouse: item.warehouse,
            warehouseName: item.warehouseName,
          };
          vo.messageWarehouseVos.push(vo1);
        });
        data.btnFlag = true;
        api.warehouse
          .endMessage(Object.assign(vo, data.infomation, data.poForm))
          .then(res => {
            if (res.code == 200) {
              vue.$message.success(res.msg);
              closed();
              data.btnFlag = false;
            } else {
              data.poForm.additionCreatOrderCode = "";
              vue.$message.warning(res.msg);
              data.btnFlag = false;
            }
          })
          .catch(err => {
            data.poForm.additionCreatOrderCode = "";
            data.btnFlag = false;
          });
      } else {
        vue.$message({
          type: "warning",
          message: "另建采购数量总和不能大于异常数量！",
        });
        return;
      }
    };
    return {
      ...refData,
      closed,
      objectSpanMethod,
      getMsg,
      onSubmit,
    };
  },
};
</script>
<style scoped lang='scss'>
#EndExceptionLog {
  .additionCreat {
    width: 50%;
    display: flex;
    .lable-additionCreat {
      width: 220px;
      line-height: 30px;
    }
  }
}
</style>
