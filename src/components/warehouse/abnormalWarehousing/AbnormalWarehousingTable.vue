<!-- AbnormalWarehousingTable 仓储异常列表 -->
<template>
  <div id="AbnormalWarehousingTable">
    <el-table v-loading="tableLoading" :data="tableData" border
      :header-cell-style="{ background: '#fafafa', color: '#2d2f30', fontWeight: 'bold', fontSize: '12px' }"
      style="width: 100%" height="calc(100vh - 230px)" @expand-change="expandChange" :expand-row-keys="expands"
      :row-key="getRowKeys" ref="table">
      <el-table-column type="expand" class="expand-class">
        <template #default>
          <el-table :data="childTableData" class="table-expand" border style="width: 100%">
            <el-table-column type="index" width="50" align="center" label="NO."></el-table-column>
            <el-table-column prop="sku" label="SKU" min-width="150px">
              <template #default="scope">
                {{ scope.row.sku }}
                <i v-if="scope.row.sku" class="el-icon-document-copy" @click="copyText(scope.row.sku)"></i>
              </template>
            </el-table-column>
            <el-table-column prop="purposeWarehouse" label="仓区">
              <template #default="scope">
                {{ scope.row.purposeWarehouse }}
              </template>
            </el-table-column>
            <el-table-column prop="purchaseNum" label="采购数量">
              <template #default="scope">
                {{ scope.row.purchaseNum }}
              </template>
            </el-table-column>
            <el-table-column prop="currentReceiptNum" label="收货数量">
              <template #default="scope">
                {{ scope.row.currentReceiptNum }}
              </template>
            </el-table-column>
            <el-table-column prop="abnormalNum" label="异常数量">
              <template #default="scope">
                {{ scope.row.abnormalNum }}
              </template>
            </el-table-column>
            <el-table-column prop="abnormalType" label="异常类型">
              <template #default="scope">
                {{ tableTypeComputed(abnormal_new_type, scope.row.abnormalType) }}
              </template>
            </el-table-column>
            <el-table-column prop="abnormalStatus" label="状态">
              <template #default="scope">
                {{ tableTypeComputed(abnormal_status, scope.row.abnormalStatus) }}
              </template>
            </el-table-column>
            <el-table-column prop="sku" label="操作" min-width="50px">
              <template #default="scope">
                <div v-if="scope.row.abnormalStatus == 'not_end'">
                  <el-button size="small" type="primary" text @click="dealWith(scope.row)" v-if="buttonAuthor.edit">处 理
                  </el-button>
                </div>
                <div>
                  <el-button size="small" type="primary" text @click="openLog(scope.row.id)" v-if="buttonAuthor.log">日 志
                  </el-button>
                </div>
                <div v-if="scope.row.abnormalType == 'bad_goods' || scope.row.abnormalType == 'error_goods'">
                  <el-button size="small" type="primary" text v-if="buttonAuthor.proof" @click="openProof(scope.row)">举
                    证</el-button>
                </div>
              </template>
            </el-table-column>
          </el-table>
        </template>
      </el-table-column>
      <el-table-column label="NO." type="index" width="50" align="center">
        <template #default="{ row }">
          <span v-if="row.index">{{ row.index * 1 + (searchMsg.current - 1) * searchMsg.size }}</span>
          <span v-else>-</span>
        </template>
      </el-table-column>
      <el-table-column label="单号信息" prop="orderCode" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>PO号：{{ scope.row.orderCode ? scope.row.orderCode : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="SKU" prop="sku" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.sku ? scope.row.sku : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="中转仓库" prop="transferWarehouse" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.transferWarehouse ? scope.row.transferWarehouse : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="仓区" prop="purposeWarehouse" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.purposeWarehouse ? scope.row.purposeWarehouse : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="运输方式" prop="transportMode" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.transportMode ? scope.row.transportMode : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="异常数量" prop="abnormalNum" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.abnormalNum ? scope.row.abnormalNum : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="时间" prop="createTime" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>创建:{{ scope.row.createTime ? scope.row.createTime : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="异常类型" prop="abnormalType" align="center" width="100" show-overflow-tooltip>
        <template #default="scope">
          <div :key="tag" v-for="tag in scope.row.abnormalType" style="margin-bottom: 3px">
            <el-tag class="tags-class">
              {{ tableTypeComputed(abnormal_new_type, tag) }}
            </el-tag>
          </div>
        </template>
      </el-table-column>
      <el-table-column label="状态" prop="abnormalStatus" width="80" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ tableTypeComputed(abnormal_status, scope.row.abnormalStatus) }}</span>
        </template>
      </el-table-column>
      <!-- <el-table-column label="备注" prop="wareRemark" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.wareRemark ? scope.row.wareRemark : "-" }}</span>
        </template>
      </el-table-column> -->
    </el-table>
    <AbnormalLog ref="AbnormalLog"></AbnormalLog>
    <WarehouseHandling ref="warehouseHandling"></WarehouseHandling>
    <ProofPop ref="ProofPop"></ProofPop>
  </div>
</template>

<script>
import { reactive, toRefs, ref, onBeforeMount, onMounted, getCurrentInstance, inject, nextTick, computed, provide, watch } from "vue";
import WarehouseHandling from "./WarehouseHandling.vue";
import { localGet, documentCopy, localSet } from "@/utils/util";
import authorButtons from "@/compositionApi/authorButtons";
import AbnormalLog from "@/components/logDialog/AbnormalLog.vue";
import ProofPop from './ProofPop.vue'

export default {
  name: "AbnormalWarehousingTable",
  props: ["tableLoading", "tableData", "searchMsg"],
  components: {
    WarehouseHandling,
    AbnormalLog,
    ProofPop
  },
  setup(prop, ctx) {
    const data = reactive({
      abnormal_new_type: [], //异常类型
      abnormal_status: [], //异常状态
      expands: [],
      childTableData: [],
      currentExpand: null
    });
    const { BUTTONS } = authorButtons();
    const buttonAuthor = BUTTONS.value;
    const { ctx: vueDev, proxy: vue } = getCurrentInstance();
    const api = vue.$http;
    const table = ref();
    onBeforeMount(() => { });
    onMounted(() => {
      data.abnormal_new_type = localGet("purchaseDict").abnormal_new_type ? localGet("purchaseDict").abnormal_new_type : [];
      data.abnormal_status = localGet("purchaseDict").abnormal_status ? localGet("purchaseDict").abnormal_status : [];
    });

    watch(
      () => prop.tableData,
      val => {
        val.forEach((i, index) => {
          i.isExpansion = false;
          i.index = index + 1;
        });
        table.value.toggleRowExpansion(data.currentExpand, false);
      }
    );

    const refData = toRefs(data);
    const abnormalTypeIsproof = ((arr1) => {
      let arr = [arr1]
      let flag = false
      let key = ['bad_goods', 'error_goods']
      for (const item of arr) {
        if (key.includes(item)) {
          flag = true
        }
      }
      return flag
    })
    // 打开举证内容
    const openProof = (row) => {
      vue.$refs.ProofPop.getInitInfo(row, '推采购', row.orderCode)
    }
    // 刷新列表
    const getTableList = inject("getTableList");

    //处理异常数据
    const dealWith = row => {
      nextTick(() => {
        vue.$refs.warehouseHandling.getMsg([row.id], row.orderCode);
      });
    };

    const expandChange = (row, expandedRows) => {
      data.currentExpand = row;
      if (expandedRows.length) {
        data.expands = [];
        if (row) {
          // localSet('code', row.orderCode)
          data.expands.push(row.orderCode);
          api.abnormal.abnormalByPurchaseOrderCode({ orderCode: row.orderCode }).then(res => {
            if (res.code == 200) {
              data.childTableData = res.data;
            }
          });
        }
      } else {
        data.expands = [];
      }
    };

    const getRowKeys = row => {
      return row.orderCode;
    };

    // 计算表格字典
    const tableTypeComputed = computed(() => {
      return function (list, dizKey) {
        if (list.length > 1 && dizKey !== -1) {
          for (let item of list) {
            if (dizKey == item.dizKey) {
              return item.value;
            }
          }
        }
      };
    });

    provide("tableTypeComputed", tableTypeComputed);

    // 查看日志
    const openLog = e => {
      let msg = {
        servers: "abnormal",
        dataApi: "warehouseAbnormalLog",
        abnormalIds: [e]
      };
      nextTick(() => {
        vue.$refs.AbnormalLog.checkLogDialog(msg);
      });
    };

    // 点击复制
    const copyText = text => {
      documentCopy(text);
    };

    return {
      ...refData,
      getTableList,
      buttonAuthor,
      dealWith,
      tableTypeComputed,
      expandChange,
      getRowKeys,
      openLog,
      copyText,
      table,
      abnormalTypeIsproof,
      openProof
    };
  }
};
</script>
<style scoped lang="scss">

</style>
