<!-- WarehouseConfirmation 仓库异常-仓库确认信息 -->
<template>
  <div id="WarehouseConfirmation">
    <div class="WarehouseConfirmation-title">仓库确认信息</div>
    <el-form :model="tableData" :inline-message="true" ref="PurchaseConfirmInfoRefundRef" class="tableForm">
      <el-table :data="[tableData]" border
        :header-cell-style="{ background: '#fafafa', color: '#2d2f30', fontWeight: 'bold', fontSize: '12px' }"
        style="width: 100%">
        <el-table-column label="运费付款方" prop="purBackFreightPayer" align="center" show-overflow-tooltip>
          <template #default="scope">
            <!-- <el-form-item
              prop="purBackFreightPayer"
              v-if="scope.row.processStatus == 'warehouse_confirmation' || scope.row.processStatus == 'warehouse_leader_refusal'"
              :rules="rules.purBackFreightPayer"
            >
              <el-select v-model="scope.row.purBackFreightPayer" clearable filterable placeholder="请选择" class="size-width" size="mini" show-overflow-tooltip>
                <el-option v-for="item in freightPayerList" :key="item.dizKey" :label="item.value" :value="item.dizKey"></el-option>
              </el-select>
            </el-form-item> -->
            <span>{{ tableTypeComputed(freightPayerList, scope.row.purBackFreightPayer) }}</span>
          </template>
        </el-table-column>
        <el-table-column label="运费付款方式" prop="wareBackFreightPayment" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span>{{ tableTypeComputed(freightPayerMethodList, scope.row.wareBackFreightPayment) }}</span>
          </template>
        </el-table-column>
        <el-table-column label="付款凭证" prop="purBackFreightImg" align="center" show-overflow-tooltip>
          <template #default="scope">
            <el-form-item prop="purBackFreightImg" v-if="
              (scope.row.processStatus == 'warehouse_confirmation' && !scope.row.purBackFreightImg) ||
              (scope.row.processStatus == 'warehouse_leader_refusal' && !scope.row.purBackFreightImg)
            " :rules="rules.purBackFreightImg">
              <UploadImage class="UploadImage" ref="UploadImage" @clickFu="receive"></UploadImage>
            </el-form-item>
            <span v-else>
              <i class="el-icon-circle-close filebadge"
                v-if="scope.row.purBackFreightImg && scope.row.processStatus != 'warehouse_leader_audit'" type="primary"
                @click="removeImg(scope.row.purBackFreightImg)"></i>
              <el-image v-if="scope.row.purBackFreightImg" @click="viewAbnormalPicture(scope.row.purBackFreightImg)"
                :src="scope.row.purBackFreightImg" style="width: 70px; height: 70px"></el-image>
              <span v-else>暂无凭证</span>
            </span>
          </template>
        </el-table-column>
        <el-table-column label="运费" prop="wareBackFreight" align="center" show-overflow-tooltip>
          <template #default="scope">
            <el-form-item prop="wareBackFreight"
              v-if="scope.row.processStatus == 'warehouse_confirmation' || scope.row.processStatus == 'warehouse_leader_refusal'"
              :rules="[{ pattern: /^(\d{0,9})(\.(\d{0,4}))?$/g, message: '最大9位数，可保留四位小数' }]">
              <el-input v-model="scope.row.wareBackFreight" maxlength="14" clearable></el-input>
            </el-form-item>
            <span v-else>{{ scope.row.wareBackFreight ? scope.row.wareBackFreight : "-" }}</span>
          </template>
        </el-table-column>
        <el-table-column label="运输方式" prop="wareBackShipModel" align="center" show-overflow-tooltip>
          <template #default="scope">
            <el-form-item prop="wareBackShipModel"
              v-if="scope.row.processStatus == 'warehouse_confirmation' || scope.row.processStatus == 'warehouse_leader_refusal'"
              :rules="[{ max: 50, message: '长度不可超过50字', target: 'change' }]">
              <el-input v-model="scope.row.wareBackShipModel" maxlength="50" clearable></el-input>
            </el-form-item>
            <span v-else>{{ scope.row.wareBackShipModel ? scope.row.wareBackShipModel : "-" }}</span>
          </template>
        </el-table-column>
        <el-table-column label="运单号" prop="wareBackWaybillNumber" align="center" show-overflow-tooltip>
          <template #default="scope">
            <el-form-item prop="wareBackWaybillNumber"
              v-if="scope.row.processStatus == 'warehouse_confirmation' || scope.row.processStatus == 'warehouse_leader_refusal'"
              :rules="[
                { pattern: /^\d{1,}$/, message: '请输入数字' },
                { max: 50, message: '长度不可超过50字', target: 'change' },
              ]">
              <el-input v-model="scope.row.wareBackWaybillNumber" maxlength="50" clearable></el-input>
            </el-form-item>
            <span v-else>{{ scope.row.wareBackWaybillNumber ? scope.row.wareBackWaybillNumber : "-" }}</span>
          </template>
        </el-table-column>
        <!-- <el-table-column label="备注" prop="wareRemark" align="center" show-overflow-tooltip>
          <template #default="scope">
            <el-form-item
              prop="wareRemark"
              v-if="scope.row.processStatus == 'warehouse_confirmation' || scope.row.processStatus == 'warehouse_leader_refusal'"
              :rules="[{ max: 250, message: '长度不可超过250字', target: 'change' }]"
            >
              <el-input v-model="scope.row.wareRemark" clearable size="mini"></el-input>
            </el-form-item>
            <span v-else>{{ scope.row.wareRemark ? scope.row.wareRemark : "-" }}</span>
          </template>
        </el-table-column> -->
        <el-table-column label="状态" prop="processStatus" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span>{{ tableTypeComputed(abnormal_process_status, scope.row.processStatus) }}</span>
          </template>
        </el-table-column>
        <el-table-column label="操作" prop="state" align="center" show-overflow-tooltip>
          <template #default="scope">
            <span v-if="scope.row.purBackFreightPayer == 'supplier_payer'">
              <div v-if="scope.row.processStatus == 'warehouse_leader_audit'" class="btn-mar">
                <el-button size="small" type="primary" @click="submitPurchase(scope.row)"
                  v-if="buttonAuthor.submitPurchase">提交采购</el-button>
              </div>
              <div
                v-if="scope.row.processStatus == 'warehouse_confirmation' || scope.row.processStatus == 'warehouse_leader_refusal'"
                class="btn-mar">
                <el-button size="small" type="primary" @click="submitPurchase(scope.row)"
                  v-if="buttonAuthor.submitPurchase">提交主管</el-button>
              </div>
              <div v-if="scope.row.processStatus == 'warehouse_leader_audit'">
                <el-button size="small" type="primary" @click="turnDown(scope.row)" v-if="buttonAuthor.submitPurchase">驳
                  回</el-button>
              </div>
            </span>
            <span v-if="scope.row.purBackFreightPayer == 'kte_payer'">
              <div
                v-if="scope.row.processStatus == 'warehouse_confirmation' || scope.row.processStatus == 'warehouse_leader_refusal'"
                class="btn-mar">
                <el-button size="small" type="primary" @click="submitPurchase(scope.row)"
                  v-if="buttonAuthor.submitPurchase">提交主管</el-button>
              </div>
              <div v-if="scope.row.processStatus == 'warehouse_leader_audit'" class="btn-mar">
                <el-button size="small" type="primary" @click="submitPurchase(scope.row)"
                  v-if="buttonAuthor.submitPurchase">确认并结束</el-button>
              </div>
              <div v-if="scope.row.processStatus == 'warehouse_leader_audit'">
                <el-button size="small" type="primary" @click="turnDown(scope.row)" v-if="buttonAuthor.submitPurchase">驳
                  回</el-button>
              </div>
            </span>
          </template>
        </el-table-column>
      </el-table>
    </el-form>
    <!-- 异常图片预览 -->
    <el-dialog v-model="isAbnormalPictures" @close="closeAbnormalPicture" destroy-on-close :close-on-press-escape="false">
      <div style="width: 100%; height: 100%">
        <el-image style="width: 100%; height: 100%" :src="abnormalPicture" fit="contain" alt=""></el-image>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import { reactive, toRefs, ref, onBeforeMount, onMounted, getCurrentInstance, inject, watch, nextTick } from "vue";
import { localGet } from "@/utils/util";
import authorButtons from "@/compositionApi/authorButtons";

export default {
  props: {
    tableData: {
      type: Object,
    },
    parentData: { type: Object },
  },
  name: "WarehouseConfirmation",
  setup(prop, ctx) {
    const data = reactive({
      isAbnormalPictures: false,
      abnormalPicture: "",
      abnormal_process_status: [],
      freightPayerList: [], //运费付款方列表
      freightPayerMethodList: [], //运费付款方式列表
      rules: {
        purBackFreightPayer: [{ required: true, message: "请选择", trigger: "change" }],
        wareBackFreightPayment: [
          { required: true, message: "请选择", trigger: "change" },
          { max: 50, message: "长度不可超过50字", target: "change" },
        ],
        purBackFreightImg: [{ required: false, message: "请上传图片", trigger: "change" }],
        wareBackFreight: [
          { required: false, message: "请输入", trigger: "blur" },
          { pattern: /^(\d{0,9})(\.(\d{0,4}))?$/g, message: "最大9位数，可保留四位小数" },
        ],
        wareBackShipModel: [{ required: false, message: "请输入", trigger: "blur" }],
        wareBackWaybillNumber: [
          { required: false, message: "请输入", trigger: "blur" },
          { pattern: /^\d{1,}$/, message: "请输入数字" },
        ],
        wareRemark: [{ required: false, message: "请输入", trigger: "blur" }],
      },
    });
    const { ctx: vueDev, proxy: vue } = getCurrentInstance();
    const api = vue.$http;
    const UploadImage = ref(null);
    const { BUTTONS } = authorButtons();
    const buttonAuthor = BUTTONS.value;
    onBeforeMount(() => { });
    onMounted(() => {
      data.abnormal_process_status = localGet("purchaseDict").abnormal_process_status ? localGet("purchaseDict").abnormal_process_status : [];
      data.freightPayerList = localGet("purchaseDict").ware_back_freight_payer ? localGet("purchaseDict").ware_back_freight_payer : [];
      data.freightPayerMethodList = localGet("purchaseDict").ware_back_freight_payment ? localGet("purchaseDict").ware_back_freight_payment : [];
    });
    const refData = toRefs(data);
    const tableTypeComputed = inject("tableTypeComputed");
    const closedParent = inject("closedParent");

    //提交采购
    const submitPurchase = e => {
      getDealWith(true);
    };

    //主管驳回
    const turnDown = e => {
      getDealWith(false);
    };

    //处理接口调用
    const getDealWith = isPass => {
      vue.$refs.PurchaseConfirmInfoRefundRef.validate(f => {
        if (f) {
          vue.$props.tableData.isPass = isPass;
          let vo = JSON.parse(JSON.stringify(vue.$props.parentData));
          vo.abnormalInfoVo = [vue.$props.tableData];
          console.log(vue.$props.tableData.processStatus);
          vo.abnormalImg = vo.abnormalImg && vo.abnormalImg.length > 0 ? vo.abnormalImg.join(",") : "";
          api.abnormal
            .abnormalDispose(vo)
            .then(res => {
              if (res.code == 200) {
                console.log(res);
                vue.$message.success(res.msg);
                // closedParent();
                api.abnormal.getAbnormalStatus({ id: vue.$props.parentData.id, abnormalTypeId: vue.$props.tableData.id, processType: vue.$props.tableData.processType }).then(resolve => {
                  if (resolve.code == 200) {
                    vue.$props.tableData.processStatus = resolve.data;
                  }
                })
              } else {
                vue.$message.warning(res.msg);
                console.log(res);
              }
            })
            .catch(err => { });
        } else {
          vue.$message.warning("请将数据填写完整！");
        }
      });
    };

    // 获取图片url
    const receive = e => {
      vue.$props.tableData.purBackFreightImg = e.link ? e.link : "";
    };

    //图片删除
    const removeImg = e => {
      vue.$props.tableData.purBackFreightImg = "";
    };

    //预览异常图片
    const viewAbnormalPicture = e => {
      data.isAbnormalPictures = true;
      data.abnormalPicture = e;
    };

    //关闭预览异常图片
    const closeAbnormalPicture = () => {
      data.isAbnormalPictures = false;
      data.abnormalPicture = "";
    };

    return {
      ...refData,
      tableTypeComputed,
      submitPurchase,
      getDealWith,
      closedParent,
      buttonAuthor,
      turnDown,
      receive,
      removeImg,
      UploadImage,
      viewAbnormalPicture,
      closeAbnormalPicture,
    };
  },
};
</script>
<style scoped lang="scss">
#WarehouseConfirmation {
  .WarehouseConfirmation-title {
    margin-bottom: 10px;
  }

  .btn-mar {
    margin-bottom: 3px;
  }

  .filebadge {
    position: relative;
    right: -75px;
    color: rgb(64 158 255);
    font-size: 18px;
    top: -50px;
    z-index: 10;
  }
}
</style>
