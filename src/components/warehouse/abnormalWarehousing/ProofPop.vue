<template>
  <div>
    <el-dialog v-model="isShow" title="举证内容" ref="table" v-if="isShow" @close="changeShow" :close-on-press-escape="false">
      <!--  数据项 -->
      <template v-if="proofInfo && proofInfo.length">
        <el-table :data="proofInfo" border class="table-container">
          <el-table-column label="NO" type="index"></el-table-column>
          <el-table-column label="举证内容" :prop="proofContent" show-overflow-tooltip>
            <template #default="{row}">
              {{row.warehouseContentProof || row.purContentProof}}
            </template>
          </el-table-column>
          <el-table-column label="图片" :prop="proofImg" min-width="220px">
            <template #default="scope">
              <el-row type="flex">
                <el-col v-for="(item,index) in tableDataImgFn(scope.row)" :key="index" :span="12">
                  <el-image style="width: 100px; height: 100px" :src="item" fit="fit" :preview-src-list="[item]" />
                </el-col>
                <el-col v-if="scope.row[proofImg].length && scope.row[proofImg].length > 2">
                  <el-button type="text" @click="viewMoreImg(scope.$index)">更多</el-button>
                </el-col>
              </el-row>
            </template>
          </el-table-column>
          <el-table-column label="操作时间" prop="createTime"></el-table-column>
          <el-table-column label="角色" prop="deptName"></el-table-column>
          <el-table-column label="操作人" prop="createUserName"></el-table-column>
        </el-table>
        <el-row></el-row>
        <Pagination :total="formData.total" class="isFixed" :is-fixed="true" :limit="formData.size"
          :page="formData.current" @update:limit="formData.size = $event" @update:page="formData.current = $event"
          :hidden="formData.total <= 0" @handleCurrentChange="handleCurrentChange" @handleSizeChange="handleSizeChange">
        </Pagination>
      </template>
      <!-- 展示和隐藏 -->
      <div @click="handleHidden" style="fontSize:20px" v-if="proofInfo && proofInfo.length">
        <i class="el-icon-caret-bottom" v-if="isHidden"></i>
        <i class="el-icon-caret-top" v-else></i>
      </div>
      <el-form ref="formRef" :model="submitFormSource" :rules="submitRules" label-width="140px" v-if="!isHidden">
        <!--       :prop="submitRules[proofContent]"-->
        <el-form-item label="请输入举证内容" :prop="title === '推仓库' ? 'purContentProof' : 'warehouseContentProof'">
          <el-input v-model.trim="submitFormSource.warehouseContentProof" :rows="5" type="textarea"
            placeholder="请输入举证内容" maxlength="500" /><span>{{submitFormSource.purContentProof.length}}/500</span>
        </el-form-item>
        <el-form-item label="上传图片">
          <UploadImage ref="UploadImageRef" @getImageList="getImageList" @clickFu="clickFu" @removeImg="removeImg">
          </UploadImage>
        </el-form-item>
      </el-form>
      <el-row justify="end" type="flex" style="marginTop : 20px">
        <el-col :md="8" :xl="4">
          <el-button @click="submitHandle" type="primary" size="small">{{title}}</el-button>
          <el-button @click="changeShow" size="small">取消</el-button>
        </el-col>
      </el-row>
      <!--   更多弹出框  -->
      <div>
        <el-dialog v-model="isShowMore" title="更多图片" :close-on-press-escape="false">
          <el-row :gutter="1">
            <el-col v-for="(item,index) in moreImg" :key="index" :md="8" :xl="4" style="marginTop :10px">
              <el-image style="width: 100px; height: 100px" :src="item" fit="fit" :preview-src-list="[item]" />
            </el-col>
          </el-row>
        </el-dialog>
      </div>
    </el-dialog>
  </div>
</template>

<script setup>
import {
  ref,
  defineExpose,
  getCurrentInstance,
  reactive,
  computed,
  onMounted,
} from "vue";
import Pagination from "@/components/pagination/Pagination.vue";
import { localGet } from "@/utils/util";
import UploadImage from "./UploadImage.vue";
import { getProofContentFn, saveOrUpdateProofContentFn } from "@/api/Proof";
const { ctx: vueDev, proxy: vue } = getCurrentInstance();
const isShow = ref(false);
const isShowMore = ref(false);
const title = ref(null);
const isHidden = ref(false);
const tableStyle = ref('30vh')
const handleHidden = () => {
  tableStyle.value = !isHidden.value ? 'cale(30vh + 100px)' : '30vh'
  isHidden.value = !isHidden.value;
}
const UploadImageRef = ref(null);
const table = ref(null);
const formData = reactive({
  current: 1,
  size: 10,
  abnormalId: "",
  total: 0,
});
const handleCurrentChange = (e) => {
  formData.current = e;
  initInfo_API(formData);
  document.querySelector(('.el-dialog__body')).scroll(0, 0)
};
const handleSizeChange = (e) => {
  formData.current = 1;
  formData.size = e;
  initInfo_API(formData);
  document.querySelector(('.el-dialog__body')).scroll(0, 0)
};
let proofInfo = ref([]);
const api = vue.$http;
let info = ref({});
let proofContent = ref("purContentProof");
let proofImg = ref("purProofImg");
let moreImg = ref([]);
let submitFormSource = reactive({
  purProofImg: [],
  purContentProof: "",
  warehouseProofImg: [],
  warehouseContentProof: "",
  abnormalTypeId: '',
  orderCode: '',
  createTime: +new Date(),
  id: ''
});
const submitRules = reactive({
  purContentProof: [
    { required: true, message: "请输入举证内容", trigger: "blur" },
  ],
  warehouseContentProof: [
    { required: true, message: "请输入举证内容", trigger: "blur" },
  ],
});
// const getImageList = (e) => {
//   submitFormSource[proofImg.value] = e.map(item => item.url);
// };

const clickFu = (e) => {
  console.log(e)
  submitFormSource[proofImg.value].push(e.link)
};

const getInitInfo = async (row, titleT, puID) => {
  submitFormSource.orderCode = puID
  submitFormSource.abnormalTypeId = row.id
  title.value = titleT;
  isShow.value = true;
  let abnormalTypeId = undefined;
  if (titleT === "推仓库") {
    //
    proofContent.value = "purContentProof";
    proofImg.value = "purProofImg";
    abnormalTypeId = row.id;
  } else {
    proofContent.value = "warehouseContentProof";
    proofImg.value = "warehouseProofImg";
    abnormalTypeId = row.id; // todo 待沟通
  }
  formData.abnormalId = row.id;
  await initInfo_API(abnormalTypeId);
};
const changeShow = () => {
  vue.$refs.formRef.resetFields();
  isShow.value = false;
};
const isScrollHidden = ref('auto !important');
const initInfo_API = async (abnormalTypeId) => {
  try {
    const { data } = await getProofContentFn(formData);
    if (data.records.length < 2) {
      isScrollHidden.value = 'hidden';
    } else {
      isScrollHidden.value = "scroll"
    }
    data.records = data.records.map(item => {
      if (item.purProofImg.length) {
        if (item.warehouseProofImg.length) {
          item.warehouseProofImg = [item.warehouseProofImg, ...item.purProofImg]
        } else {
          item.warehouseProofImg = item.purProofImg
        }
      }
      return { ...item }
    })
    proofInfo.value = data.records || [];
    formData.current = data.current;
    formData.total = data.total;
    formData.size = data.size;
  } catch (e) {
    console.log(e);
  }
};
const tableDataImgFn = (source) => {
  let tableDataImg = [];
  if (source[proofImg.value] && source[proofImg.value].length) {
    if (source[proofImg.value]?.length <= 2) {
      tableDataImg = source[proofImg.value];
    } else {
      tableDataImg = source[proofImg.value].slice(0, 2);
    }
  }
  return tableDataImg;
};
const removeImg = (file) => {
  submitFormSource[proofImg.value].map((item, index) => {
    if (item == file) {
      submitFormSource[proofImg.value].splice(index, 1);
    }
  });
}
const submitHandle = async (index) => {
  try {
    await vue.$refs.formRef.validate();
    await saveOrUpdateProofContentFn(submitFormSource);
    UploadImageRef.value.removeImg();
    vue.$refs.formRef.resetFields()
    submitFormSource[proofImg.value] = [];
    console.log(submitFormSource[proofImg.value])
    vue.$message.success("操作成功!");
    await initInfo_API();
  } catch (e) {
    console.log(e)
    // noop
  }
};

const viewMoreImg = (index) => {
  let info = proofInfo.value[index];
  moreImg.value = info[proofImg.value];
  isShowMore.value = true;
};
defineExpose({ getInitInfo });
</script>

<style scoped>
.price {
  box-sizing: border-box;
  padding: 0 20px;
  font-size: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.isFixed {
  position: static !important;
  /* //display: flex; */
  /* //justify-content: flex-end; */
  bottom: 0;
  right: 0;
  /* //width: 50%; */
  /* //max-width: 80%; */
  border: none;
  background: #fff;
  border-radius: 50px;
  /* margin: 60px 40px; */
  /* //margin: 15px 15px; */
  z-index: 1100;
  /* //padding: 5px 20px */
}

:deep(.el-table) {
  max-height: v-bind(tableStyle);
  overflow-y: auto !important;
}

:deep(.el-table::before) {
  width: 0px;
  height: 0px;

}
</style>
<style>
.el-table::before {
  width: 0px;
  height: 0px;
}
</style>
