<!--replyExceptionLog 回复异常  -->
<template>
  <div id="replyExceptionLog">
    <el-dialog title="回复异常" v-model="dialogVisible" :close-on-click-modal="false" width="60%" @close="closed" :close-on-press-escape="false">
      <el-form ref="ruleFormRef" :model="ruleForm" label-width="100px">
        <el-form-item label="处理方式：" prop="treatmentMethod">
          <span>{{ ruleForm.treatmentMethod }}</span>
        </el-form-item>
        <!-- 处理方式为补发时 展示类型 -->
        <el-form-item label="类型：" v-if="submitData.processingMethod == 'make_up'">
          <span>另建po单</span>
        </el-form-item>
        <!-- 处理方式为退款时进行流水号输入 -->
        <el-form-item label="流水号：" prop="serialNumber" v-if="submitData.processingMethod == 'refund'">
          <el-input clearable placeholder="请输入流水号" type="number" show-word-limit v-model.trim="ruleForm.serialNumber"></el-input>
        </el-form-item>
        <el-form-item label="处理概要：" prop="textarea">
          <el-input clearable type="textarea" :rows="5" placeholder="请输入处理概要..." maxlength="100" show-word-limit v-model.trim="ruleForm.textarea"></el-input>
        </el-form-item>
        <el-form-item label="异常图片:" prop="imageUrl">
          <UploadImage ref="UploadImage" @clickFu="receive"></UploadImage>
        </el-form-item>
      </el-form>

      <template #footer>
        <span class="dialog-footer">
          <el-button size="mini" @click="closed">取 消</el-button>
          <el-button size="mini" type="primary" :loading="btnFlag" :disabled="btnFlag" @click="onSubmit">确 定</el-button>
        </span>
      </template>
    </el-dialog>
  </div>
</template>

<script>
import { reactive, toRefs, ref, onBeforeMount, onMounted, getCurrentInstance, nextTick, inject } from "vue";
import { localGet } from "@/utils/util";
export default {
  name: "replyExceptionLog",
  setup(prop, ctx) {
    const data = reactive({
      dialogVisible: false, //
      btnFlag: false,
      ruleForm: {
        treatmentMethod: "",
        textarea: "",
        imageUrl: [],
        //当处理方式为退款时需要输入的流水号
        serialNumber: "",
      },
      // 点击确定发送请求定位的参数
      submitData: {},
      // 处理方式字典
      abnormal_processing_method: [],
      //图片计时器
      timer: null,
    });
    const { ctx: vueDev, proxy: vue } = getCurrentInstance();
    const api = vue.$http;
    onBeforeMount(() => {});
    onMounted(() => {
      data.abnormal_processing_method =
        localGet("purchaseDict") && localGet("purchaseDict").abnormal_processing_method ? localGet("purchaseDict").abnormal_processing_method : [];
    });
    const refData = toRefs(data);

    // 取消
    const closed = () => {
      data.dialogVisible = false;
      nextTick(() => {
        vue.$refs.UploadImage.removeBefore();
        vue.$refs.ruleFormRef.clearValidate();
        vue.$refs.ruleFormRef.resetFields();
      });
      clearTimeout(data.timer);
    };

    // 打开弹框
    const openLog = info => {
      data.submitData = info;
      let msg = {
        imgLimit: 9,
        fileList: [],
        pathName: "warehouseManagement/qualityInspection/img",
        isUpdate: true,
      };
      nextTick(() => {
        data.timer = setTimeout(() => {
          vue.$refs.UploadImage.getImgMsg(msg);
        }, 500);
      });
      data.dialogVisible = true;

      if (info.processingMethod) {
        data.abnormal_processing_method.map(item => {
          if (item.dizKey == info.processingMethod) {
            data.ruleForm.treatmentMethod = item.value;
          }
        });
      }
    };
    const checkAbnormalMessages = inject("checkAbnormalMessages");

    // 确定
    const onSubmit = () => {
      //回复异常时 通过处理方式选择的不同情况 进行处理下一步
      // // 选择方式为补发时
      // if (data.ruleForm.treatmentMethod == "make_up") {
      // }
      // //选择为退款时  --》只有财务才能进行提交
      // if (data.ruleForm.treatmentMethod == "refund") {
      // }
      // //选择方式为报损时 --》通过时 财务结束异常   不通过采购再次进行上传
      // if (data.ruleForm.treatmentMethod == "report_damage") {
      // }
      let vo = {
        abnormalType: data.submitData.abnormalType,
        context: data.ruleForm.textarea,
        imageUrl: data.ruleForm.imageUrl,
        orderCode: data.submitData.orderCode,
        processingMethod: data.ruleForm.treatmentMethod,
        sku: data.submitData.sku,
        serialNumber: data.ruleForm.serialNumber,
      };
      data.btnFlag = true;
      api.warehouse
        .replyMessage(vo)
        .then(res => {
          if (res.code == 200) {
            vue.$message({
              type: "success",
              message: res.msg,
            });
            data.btnFlag = false;
            checkAbnormalMessages(vo.orderCode, vo.sku, data.submitData.abnormalType);
            // vue.$parent.openLog({ sku: vo.sku, orderCode: vo.orderCode });
            closed();
          } else {
            data.btnFlag = false;
          }
        })
        .catch(e => {
          data.btnFlag = false;
        });
    };

    // 上传图片
    const receive = e => {
      if (e.link) {
        data.ruleForm.imageUrl.push(e.link);
      }
    };

    return {
      ...refData,
      closed,
      onSubmit,
      receive,
      openLog,
      checkAbnormalMessages,
    };
  },
};
</script>
<style scoped lang="scss">
</style>
