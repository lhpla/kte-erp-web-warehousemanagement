<!-- ProductOperation 仓库异常-产品操作 -->
<template>
  <div id="ProductOperation">
    <div class="title">产品操作异常</div>
    <el-table :data="[tableData]" border
      :header-cell-style="{ background: '#fafafa', color: '#2d2f30', fontWeight: 'bold', fontSize: '12px' }"
      style="width: 100%">
      <el-table-column label="SKU" prop="sku" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.sku }}</span>
        </template>
      </el-table-column>
      <el-table-column label="是否更换SKU" prop="isReplace" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.purIsChangeSku ? "是" : "否" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="新SKU" prop="newSku" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.newSku ? scope.row.newSku : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="仓区" prop="purposeWarehouse" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.purposeWarehouse }}</span>
        </template>
      </el-table-column>
      <el-table-column label="确定数量" prop="purNum" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.purNum }}</span>
        </template>
      </el-table-column>
      <el-table-column label="状态" prop="processStatus" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ tableTypeComputed(abnormal_process_status, scope.row.processStatus) }}</span>
        </template>
      </el-table-column>
      <el-table-column label="操作" prop="abnormalNum" align="center" show-overflow-tooltip>
        <template #default="scope">
          <div class="btn-mar" v-if="scope.row.processStatus == 'warehouse_confirmation'">
            <el-button type="primary" size="small" @click="submitWarehousing(scope.row)"
              v-if="buttonAuthor.submitWarehousing">确认入库</el-button>
          </div>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script>
import { reactive, toRefs, ref, onBeforeMount, onMounted, getCurrentInstance, inject } from "vue";
import { localGet } from "@/utils/util";
import authorButtons from "@/compositionApi/authorButtons";

export default {
  props: {
    tableData: {
      type: Object,
    },
    parentData: {
      type: Object,
    },
  },
  name: "ProductOperation",
  setup(prop, ctx) {
    const data = reactive({
      abnormal_process_status: [],
    });
    const { ctx: vueDev, proxy: vue } = getCurrentInstance();
    const api = vue.$http;
    const { BUTTONS } = authorButtons();
    const buttonAuthor = BUTTONS.value;
    onBeforeMount(() => { });
    onMounted(() => {
      data.abnormal_process_status = localGet("purchaseDict").abnormal_process_status ? localGet("purchaseDict").abnormal_process_status : [];
    });
    const refData = toRefs(data);
    const tableTypeComputed = inject("tableTypeComputed");
    const closedParent = inject("closedParent");

    const submitWarehousing = e => {
      getDealWith(true);
    };

    //处理接口调用
    const getDealWith = isPass => {
      vue.$props.tableData.isPass = isPass;
      let vo = JSON.parse(JSON.stringify(vue.$props.parentData));
      vo.abnormalInfoVo = [vue.$props.tableData];
      console.log(vue.$props.tableData.processStatus);
      vo.abnormalImg = vo.abnormalImg && vo.abnormalImg.length > 0 ? vo.abnormalImg.join(",") : "";
      api.abnormal
        .abnormalDispose(vo)
        .then(res => {
          if (res.code == 200) {
            console.log(res);
            vue.$message.success(res.msg);
            // closedParent();
            api.abnormal.getAbnormalStatus({ id: vue.$props.parentData.id, abnormalTypeId: vue.$props.tableData.id, processType: vue.$props.tableData.processType }).then(resolve => {
              if (resolve.code == 200) {
                vue.$props.tableData.processStatus = resolve.data;
              }
            })
          } else {
            vue.$message.warning(res.msg);
            console.log(res);
          }
        })
        .catch(err => { });
    };

    return {
      ...refData,
      tableTypeComputed,
      submitWarehousing,
      getDealWith,
      closedParent,
      buttonAuthor,
    };
  },
};
</script>
<style scoped lang='scss'>
#ProductOperation {
  .title {
    margin-bottom: 10px;
  }
}
</style>