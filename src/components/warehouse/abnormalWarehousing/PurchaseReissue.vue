<!-- PurchaseReissue 采购信息操作--补发 -->
<template>
  <div id="PurchaseReissue">
    <div class="PurchaseReissue-title">采购信息操作--补发</div>
    <el-table :data="[tableData]" border
      :header-cell-style="{ background: '#fafafa', color: '#2d2f30', fontWeight: 'bold', fontSize: '12px' }"
      style="width: 100%">
      <el-table-column label="中转仓库" prop="transferWarehouse" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.transferWarehouse ? scope.row.transferWarehouse : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="仓区" prop="purposeWarehouse" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.purposeWarehouse ? scope.row.purposeWarehouse : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="PO单号" prop="purchaseOrderCode" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.purchaseOrderCode ? scope.row.purchaseOrderCode : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="SKU" prop="sku" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.sku ? scope.row.sku : "-" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="补发数量" prop="purNum" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.purNum ? scope.row.purNum : "0" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="单价" prop="purPrice" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.purPrice ? scope.row.purPrice : "0" }}</span>
        </template>
      </el-table-column>
      <el-table-column label="总金额" prop="purTotalAmount" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ scope.row.purTotalAmount ? scope.row.purTotalAmount : "0" }}</span>
        </template>
      </el-table-column>
      <!-- 少货时 需进行举证 -->
      <el-table-column label="举证" prop="purProofImg" align="center" show-overflow-tooltip
        v-if="tableData.processStatus == 'purchase_leader_audit'">
        <template #default="scope">
          <div>
            <el-button type="primary" size="small" @click="giveEvidence(scope.row.purProofImg)"
              v-if="!scope.row.purProofImg.length">举证</el-button>
            <el-button type="primary" size="small" @click="giveEvidence(scope.row.purProofImg)"
              v-if="scope.row.purProofImg.length">查看举证</el-button>
          </div>
        </template>
      </el-table-column>
      <el-table-column label="状态" prop="processStatus" align="center" show-overflow-tooltip>
        <template #default="scope">
          <span>{{ tableTypeComputed(abnormal_process_status, scope.row.processStatus) }}</span>
        </template>
      </el-table-column>
      <el-table-column label="操作" prop="abnormalNum" align="center" show-overflow-tooltip>
        <template #default="scope">
          <div v-if="
            scope.row.processStatus == 'not_processed' || scope.row.processStatus == 'purchase_confirmation' || scope.row.processStatus == 'purchase_leader_refusal'
          ">
            <el-button type="primary" size="small" @click="pushWarehouse(scope.row)"
              v-if="buttonAuthor.submitRepository">推仓库</el-button>
          </div>
          <span v-else>-</span>
        </template>
      </el-table-column>
    </el-table>

    <el-dialog title="举证" v-model="dialogVisible" width="40%" :close-on-click-modal="false" @close="closed"
      destroy-on-close :close-on-press-escape="false">
      <UploadImage ref="uploadImage" @clickFu="receive" @removeImg="removeImg"></UploadImage>
      <div style="margin-top: 15px">
        描述：
        <el-input style="margin-top: 15px" maxlength="250" type="textarea" v-model="describe" placeholder="请输入描述">
        </el-input>
      </div>
      <template #footer>
        <el-button type="primary" size="small" @click="save">保 存</el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script>
import { reactive, toRefs, ref, onBeforeMount, onMounted, getCurrentInstance, nextTick, inject } from "vue";
import authorButtons from "@/compositionApi/authorButtons";
import { localGet } from "@/utils/util";

export default {
  name: "PurchaseReissue",
  props: {
    tableData: {
      Object,
    },
    parentData: {
      Object,
    },
  },
  setup(prop, ctx) {
    const data = reactive({
      dialogVisible: false,
      purProofImg: [],
      describe: "",
      abnormal_process_status: [],
    });
    const { ctx: vueDev, proxy: vue } = getCurrentInstance();
    const tableTypeComputed = inject("tableTypeComputed");
    const closedParent = inject("closedParent");

    const { BUTTONS } = authorButtons();
    const buttonAuthor = BUTTONS.value;
    const api = vue.$http;
    const uploadImage = ref(null);
    onBeforeMount(() => { });
    onMounted(() => {
      data.abnormal_process_status = localGet("purchaseDict").abnormal_process_status ? localGet("purchaseDict").abnormal_process_status : [];
    });
    const refData = toRefs(data);

    //推仓库
    const pushWarehouse = e => {
      if (e.processStatus == "purchase_leader_audit") {
        if (e.purProofMessage) {
          if (e.purProofImg.length) {
            getDealWith(true);
          } else vue.$message.warning("请上传举证图片！");
        } else vue.$message.warning("请先对举证信息完善！");
      } else {
        getDealWith(true);
      }
    };

    //处理接口调用
    const getDealWith = isPass => {
      vue.$props.tableData.isPass = isPass;
      let vo = JSON.parse(JSON.stringify(vue.$props.parentData));
      vo.abnormalInfoVo = [JSON.parse(JSON.stringify(vue.$props.tableData))];
      vo.abnormalInfoVo.map(i => {
        if (i.purDamageImg.length > 0) {
          i.purDamageImg = i.purDamageImg.join(",");
        } else {
          i.purDamageImg = "";
        }
      });
      vo.abnormalImg = vo.abnormalImg && vo.abnormalImg.length > 0 ? vo.abnormalImg.join(",") : "";
      api.abnormal
        .abnormalDispose(vo)
        .then(res => {
          if (res.code == 200) {
            console.log(res);
            vue.$message.success(res.msg + ",请在普通质检页面进行二次入库！");
            // closedParent();
            api.abnormal.getAbnormalStatus({ id: vue.$props.parentData.id, abnormalTypeId: vue.$props.tableData.id, processType: vue.$props.tableData.processType }).then(resolve => {
              if (resolve.code == 200) {
                vue.$props.tableData.processStatus = resolve.data;
              }
            })
          } else {
            vue.$message.warning(res.msg);
            console.log(res);
          }
        })
        .catch(err => { });
    };

    //举证
    const giveEvidence = e => {
      data.dialogVisible = true;
      let file = {
        imgLimit: 9,
        isUpdate: true,
        fileList: [],
        pathName: "",
      };
      if (e) {
        data.purProofImg = e.split(",");
        e.split(",").map(item => {
          let obj = {
            url: item,
          };
          file.fileList.push(obj);
        });
      }
      nextTick(() => {
        uploadImage.value.getImgMsg(file, file.fileList);
      });
    };

    //关闭举证
    const closed = () => {
      data.dialogVisible = false;
    };

    // 获取图片url
    const receive = e => {
      if (e) {
        data.purProofImg.push(e.link);
      }
    };

    //保存举证
    const save = () => {
      vue.$props.tableData.purProofImg = data.purProofImg.length ? data.purProofImg.join(",") : [];
      //获取举证描述
      vue.$props.tableData.purProofMessage = data.describe;
      data.dialogVisible = false;
      data.purProofImg = [];
      data.describe = "";
    };

    //删除图片
    const removeImg = e => {
      data.purProofImg = data.purProofImg.filter(item => {
        return item != e;
      });
    };
    return {
      ...refData,
      pushWarehouse,
      giveEvidence,
      closed,
      receive,
      uploadImage,
      save,
      removeImg,
      getDealWith,
      buttonAuthor,
      tableTypeComputed,
      closedParent,
    };
  },
};
</script>
<style scoped lang='scss'>
#PurchaseReissue {
  .PurchaseReissue-title {
    margin-bottom: 10px;
  }
}
</style>