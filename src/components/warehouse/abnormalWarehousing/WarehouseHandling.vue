<!-- WarehouseHandling 仓库异常处理 -->
<template>
  <div id="WarehouseHandling">
    <!-- v-loading="loading" -->
    <el-dialog v-model="dialogVisible" width="80%" :close-on-click-modal="false" @close="closedParent" destroy-on-close
      :close-on-press-escape="false">
      <template #header>
        <span>{{ title }}</span>
        <span style="margin-left: 30px">PO单：{{ orderCode }}</span>
      </template>
      <div v-for="item in tableData" :key="item.id">
        <div>
          <div class="basicInfoClass">
            <div class="detailInfo">
              <div class="logistics">物流号:{{ item.logisticsNum }}</div>
              <div class="sku">SKU:{{ item.sku }}</div>
              <div class="buyer">采购员:{{ item.buyerName }}</div>
            </div>
            <div class="choose">
              <span v-if="!tableData[0].isLockProcessType && item.abnormalType == 'less_goods'">
                <span>处理方式：</span>
                <el-select filterable clearable v-model="tableData[0].processType" placeholder="请选择"
                  @change="processTypeChange">
                  <el-option v-for="item in withEayCopyList" :key="item.dizKey" :label="item.value"
                    :value="item.dizKey"></el-option>
                </el-select>
              </span>
              <span v-else>
                <span>处理方式：{{ tableTypeComputed(withEayList, tableData[0].processType) }}</span>
              </span>
            </div>
          </div>
          <el-table :data="[item]" border
            :header-cell-style="{ background: '#fafafa', color: '#2d2f30', fontWeight: 'bold', fontSize: '12px' }"
            style="width: 100%">
            <el-table-column label="中转仓库" prop="transferWarehouse" align="center" show-overflow-tooltip>
              <template #default="scope">
                <span>{{ scope.row.transferWarehouse ? scope.row.transferWarehouse : "-" }}</span>
              </template>
            </el-table-column>
            <el-table-column label="仓区" prop="purposeWarehouse" align="center" show-overflow-tooltip>
              <template #default="scope">
                <span>{{ scope.row.purposeWarehouse ? scope.row.purposeWarehouse : "-" }}</span>
              </template>
            </el-table-column>
            <el-table-column label="采购建议数量" prop="purchaseNum" align="center" show-overflow-tooltip>
              <template #default="scope">
                <span>{{ scope.row.purchaseNum ? scope.row.purchaseNum : "-" }}</span>
              </template>
            </el-table-column>
            <el-table-column label="收货数量" prop="currentReceiptNum" align="center" show-overflow-tooltip>
              <template #default="scope">
                <span>{{ scope.row.currentReceiptNum ? scope.row.currentReceiptNum : "-" }}</span>
              </template>
            </el-table-column>
            <el-table-column label="异常数量" prop="abnormalNum" align="center" show-overflow-tooltip>
              <template #default="scope">
                <span>{{ scope.row.abnormalNum ? scope.row.abnormalNum : "-" }}</span>
              </template>
            </el-table-column>
            <el-table-column label="异常类型" prop="abnormalType" align="center" show-overflow-tooltip>
              <template #default="scope">
                <el-tag class="tags-class">
                  {{ tableTypeComputed(abnormal_new_type, scope.row.abnormalType) }}
                </el-tag>
              </template>
            </el-table-column>
            <el-table-column label="异常描述" prop="abnormalContext" align="center" show-overflow-tooltip>
              <template #default="scope">
                <span>{{ scope.row.abnormalContext ? scope.row.abnormalContext : "-" }}</span>
              </template>
            </el-table-column>
            <el-table-column label="异常图片" prop="abnormalImg" align="center" show-overflow-tooltip>
              <template #default="scope">
                <el-image v-if="scope.row.abnormalImg.length > 0" @click="viewAbnormalPicture(scope.row.abnormalImg[0])"
                  :src="scope.row.abnormalImg[0]" style="width: 80px; height: 80px"></el-image>
                <span v-if="scope.row.abnormalImg.length > 1">
                  <el-button type="primary" text size="small" @click="more(scope.row.abnormalImg)">更 多</el-button>
                </span>
                <span v-else-if="scope.row.abnormalImg.length == 0">暂无图片</span>
              </template>
            </el-table-column>
          </el-table>
        </div>

        <span v-for="ite in item.abnormalInfoVo" :key="ite.id">
          <!-- 采购确认信息部分 -->
          <PurchaseConfirmation :tableData="ite" :parentData="item" ref="PurchaseConfirmation"
            v-if="ite.processType == 'back_the_goods'"></PurchaseConfirmation>
          <!-- 仓库确认信息部分 -->
          <WarehouseConfirmation :tableData="ite" :parentData="item" ref="WarehouseConfirmation"
            v-if="ite.processType == 'back_the_goods'"></WarehouseConfirmation>
          <!-- 产品操作异常部分 -->
          <ProductOperation :tableData="ite" :parentData="item" ref="ProductOperation"
            v-if="ite.processType == 'warehousing'"></ProductOperation>
          <!-- 少货异常未选择处理方式时 可在此处选择补发处理 并且在此次进行推仓库动作  补发--推仓库-->
          <PurchaseReissue
            v-show="ite.processType == 'reissue' && item.abnormalType == 'less_goods' && item.processType == 'reissue'"
            ref="PurchaseReissue" :tableData="ite" :parentData="item"></PurchaseReissue>
        </span>
      </div>

      <el-dialog title="全部图片" v-model="dialogVisibleMore" width="40%" :close-on-click-modal="false" @close="closedMore"
        destroy-on-close :close-on-press-escape="false">
        <span v-for="(url, ind) of allImage" :key="ind" style="margin-left: 5px">
          <span v-if="url">
            <el-image @click="viewAbnormalPicture(url)" style="width: 100px; height: 90px; margin-bottom: 5px"
              fit="contain" :src="url"></el-image>
          </span>
        </span>
      </el-dialog>
    </el-dialog>
    <!-- 异常图片预览 -->
    <el-dialog v-model="isAbnormalPictures" @close="closeAbnormalPicture" destroy-on-close
      :close-on-press-escape="false">
      <div style="width: 100%; height: 100%">
        <el-image style="width: 100%; height: 100%" :src="abnormalPicture" fit="contain" alt=""></el-image>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import { reactive, toRefs, ref, onBeforeMount, onMounted, getCurrentInstance, inject, provide } from "vue";
import ProductOperation from "./ProductOperation.vue";
import WarehouseConfirmation from "./WarehouseConfirmation.vue";
import PurchaseConfirmation from "./PurchaseConfirmation.vue";
import PurchaseReissue from './PurchaseReissue.vue'
import { localGet } from "@/utils/util";

export default {
  name: "WarehouseHandling",
  components: {
    PurchaseConfirmation,
    WarehouseConfirmation,
    ProductOperation,
    PurchaseReissue
  },
  setup(prop, ctx) {
    const data = reactive({
      isAbnormalPictures: false,
      abnormalPicture: "",
      basicInfo: {
        orderCode: "PO2203091700006T",
        logisticsNum: "SL20220309170009",
        sku: "MS-MS-Ms-102",
        buyer: "admin",
        handling: "",
      }, //基础信息
      orderCode: "",
      dialogVisible: false,
      dialogVisibleMore: false,
      withEayList: [], //处理方式
      tableData: [],
      allImage: [],
      title: "仓储异常处理",
      abnormal_new_type: [],
      withEayCopyList: [
        {
          dizKey: "reissue",
          value: "补发",
        },
      ],
    });
    const { ctx: vueDev, proxy: vue } = getCurrentInstance();
    const api = vue.$http;
    onBeforeMount(() => { });
    onMounted(() => {
      data.withEayList = localGet("purchaseDict").abnormal_process_type ? localGet("purchaseDict").abnormal_process_type : localGet("purchaseDict").abnormal_process_type;
      data.abnormal_new_type = localGet("purchaseDict").abnormal_new_type ? localGet("purchaseDict").abnormal_new_type : localGet("purchaseDict").abnormal_new_type;
    });
    const refData = toRefs(data);
    const tableTypeComputed = inject("tableTypeComputed");

    //打开弹框 获取信息
    const getMsg = (e, po) => {
      data.dialogVisible = true;
      data.orderCode = po;
      console.log(data.orderCode,e);
      api.abnormal.getNewAbnormalDetail({abnormalId:e}).then(res => {
        if (res.code == 200) {
          res.data.map(item => {
            item.abnormalImg = item.abnormalImg ? item.abnormalImg.split(",") : [];
          });
          res.data.map(ite => {
            if (ite.abnormalInfoVo.length) {
              ite.abnormalInfoVo.map(item => {
                item.id = item.id == -1 ? "" : item.id;
                item.financeReceiveAmount = item.financeReceiveAmount == -1 ? "" : item.financeReceiveAmount;
                item.purDamageAmount = item.purDamageAmount == -1 ? "" : item.purDamageAmount;
                item.purDeductAmount = item.purDeductAmount == -1 ? "" : item.purDeductAmount;
                item.purTotalAmount = item.purTotalAmount == -1 ? "" : item.purTotalAmount;
                item.purNum = item.purNum == -1 ? "" : item.purNum;
                item.purOverWarehouseId = item.purOverWarehouseId == -1 ? "" : item.purOverWarehouseId;
                item.purPrice = item.purPrice == -1 ? "" : item.purPrice;
                item.purRefundFreight = item.purRefundFreight == -1 ? "" : item.purRefundFreight;
                item.purRepairPrice = item.purRepairPrice == -1 ? "" : item.purRepairPrice;
                item.purSupplierId = item.purSupplierId == -1 ? "" : item.purSupplierId;
                item.purTotalAmount = item.purTotalAmount == -1 ? "" : item.purTotalAmount;
                item.transferWarehouseId = item.transferWarehouseId == -1 ? "" : item.transferWarehouseId;
                item.wareBackFreight = item.wareBackFreight == -1 ? "" : item.wareBackFreight;
                item.realRefundPrice = item.realRefundPrice == -1 ? '' : item.realRefundPrice;
              });
            }
          });
          data.tableData = res.data;
          console.log(data.tableData);
        } else {
          vue.$message.warning(res.msg);
        }
      });
    };

    //选择处理方式
    const processTypeChange = e => {
      if (e) {
        let vo = {
          processType: e,
          abnormalId: data.tableData[0].id,
        };
        api.abnormal.getAbnormalDetailOfProcessType(vo).then(res => {
          if (res.code == 200) {
            res.data.abnormalInfoVo.map(item => {
              item.id = item.id == -1 ? "" : item.id;
              item.financeReceiveAmount = item.financeReceiveAmount == -1 ? "" : item.financeReceiveAmount;
              item.purDamageAmount = item.purDamageAmount == -1 ? "" : item.purDamageAmount;
              item.purDeductAmount = item.purDeductAmount == -1 ? "" : item.purDeductAmount;
              item.purTotalAmount = item.purTotalAmount == -1 ? "" : item.purTotalAmount;
              item.purNum = item.purNum == -1 ? "" : item.purNum;
              item.purOverWarehouseId = item.purOverWarehouseId == -1 ? "" : item.purOverWarehouseId;
              item.purPrice = item.purPrice == -1 ? "" : item.purPrice;
              item.purRefundFreight = item.purRefundFreight == -1 ? "" : item.purRefundFreight;
              item.purRepairPrice = item.purRepairPrice == -1 ? "" : item.purRepairPrice;
              item.purSupplierId = item.purSupplierId == -1 ? "" : item.purSupplierId;
              item.purTotalAmount = item.purTotalAmount == -1 ? "" : item.purTotalAmount;
              item.transferWarehouseId = item.transferWarehouseId == -1 ? "" : item.transferWarehouseId;
              item.wareBackFreight = item.wareBackFreight == -1 ? "" : item.wareBackFreight;
              item.realRefundPrice = item.realRefundPrice == -1 ? '' : item.realRefundPrice;
            });
            data.tableData[0].abnormalInfoVo = res.data.abnormalInfoVo;
          }
        });
      }
      console.log(data.tableData);
    };

    //关闭弹框
    const closedParent = () => {
      data.dialogVisible = false;
    };

    provide("closedParent", closedParent);

    //查看更多图片
    const more = e => {
      data.allImage = e;
      data.dialogVisibleMore = true;
    };

    //关闭更多图片查看
    const closedMore = () => {
      data.allImage = [];
      data.dialogVisibleMore = false;
    };

    //预览异常图片
    const viewAbnormalPicture = e => {
      data.isAbnormalPictures = true;
      data.abnormalPicture = e;
    };

    //关闭预览异常图片
    const closeAbnormalPicture = () => {
      data.isAbnormalPictures = false;
      data.abnormalPicture = "";
    };

    return {
      ...refData,
      getMsg,
      closedParent,
      more,
      closedMore,
      tableTypeComputed,
      viewAbnormalPicture,
      closeAbnormalPicture,
      processTypeChange,
    };
  },
};
</script>
<style scoped lang="scss">
#WarehouseHandling {
  .basicInfoClass {
    display: flex;

    .detailInfo {
      display: flex;
      margin-bottom: 20px;
      height: 40px;
      width: 70%;
      line-height: 40px;

      .po {
        width: 30%;
      }

      .logistics {
        width: 30%;
        margin-left: 3%;
      }

      .sku {
        width: 30%;
        margin-left: 3%;
      }

      .buyer {
        width: 30%;
        margin-left: 3%;
      }
    }

    .choose {
      width: 30%;
      display: flex;
      height: 40px;
      align-items: center;
    }
  }
}
</style>
